--SÒLO ES UNA PRUEBA
CREATE OR REPLACE TRIGGER GENERA_CARGO
BEFORE INSERT ON INSCRIPCION
FOR EACH ROW
DECLARE
	VNUM NUMBER(2);
	BEGIN
		SELECT COUNT(*) INTO VNUM FROM NIVEL;
--		IF SQL%NOTFOUND THEN
--			DBMS_OUTPUT.PUT_LINE('NO HUBO RESPUESTA');
--		ELSE
--			INSERT INTO RESPALDO VALUES(:NEW.IDPERSONA,:NEW.NOMBREPERSONA,
--				:NEW.EDADPERSONA);
--			DBMS_OUTPUT.PUT_LINE('REGISTRO RESPALDADO');
--		END IF;
	DBMS_OUTPUT.PUT_LINE('TOTAL NIVELES ES: '|| VNUM);
END GENERA_CARGO;
/


--####### INICIO 	##############
CREATE SEQUENCE AUTO_IDDESCUENTO
INCREMENT BY 1 MINVALUE 10000001;

--2DA PARTE: ALTA SERVICIOS
--ESTE PROCEDIMIENTO YA ESTÀ FUNCIONANDO
CREATE OR REPLACE PROCEDURE PAGAR_CARGO(IDCARGO$ IN NUMBER,ABONO$ IN NUMBER)
AS
	FECHAPAGO$ DATE:=SYSDATE;
	ABONADO$ NUMBER(11,2);
BEGIN
	SELECT ABONO INTO ABONADO$ FROM CARGO WHERE IDCARGO=IDCARGO$;
	IF SQL%NOTFOUND THEN
		DBMS_OUTPUT.PUT_LINE('NO EXISTE EL CARGO A SALDAR');
	ELSE
		IF ABONADO$ > 0 THEN --SÒLO SE PUEDE ABONAR UNA ÙNICA VEZ	
			DBMS_OUTPUT.PUT_LINE('ESTE CARGO YA HA SIDO ABONADO TOTAL O PARCIALMENTE');
		ELSE
			UPDATE CARGO SET ABONO=ABONO$, FECHAPAGO=FECHAPAGO$ WHERE IDCARGO=IDCARGO$;
			DBMS_OUTPUT.PUT_LINE('SE SALDÒ EL CARGO');
			COMMIT;
			PROC_AFTER_GENERA_DESCUENTO(IDCARGO$);--LLAMA AL PROCEDIMIENTO QUE GENARA LOS DESCUENTOS
		END IF;
	END IF;
END PAGAR_CARGO;
/

EXEC PAGAR_CARGO(10000003,2000);

--EL TRIGGER PARA LA TABLA CARGO OCURRE DESPÙES DE ACTUALIZAR, CUANDO SE PAGA UN CARGO GENERA UN DESCUENTO
--ESTE TRIGGER FUNCIONA HASTA QUE INTENTA MODIFICAR DATOS DE LA TABLA QUE LO ACTIVA, ES AHI CUANDO FALLA (DICE QUE ESTA MUTANDO)
CREATE OR REPLACE TRIGGER GENERA_DESCUENTO
AFTER UPDATE ON CARGO
FOR EACH ROW
DECLARE
	IDCARGO$		NUMBER(8);
	FECHACARGO$ 	DATE;
	FECHAVEN$ 	DATE;
	FECHAPAGO$ 	DATE;
	IMPORTE$ 	NUMBER(12,2);
	NUMERO_PAGOS$ NUMBER(2);
	PAGO$ 		 NUMBER(3);
	ABONO$ 		NUMBER(12,2);
	CVS$ 		CHAR(2);
	CARGO$ 		NUMBER(8);
	IDINSCRIPCION$ NUMBER(8);
	IDSERVICIO$    NUMBER(8);

	BEGIN

		IDCARGO$:=:NEW.IDCARGO;
		FECHACARGO$:=:NEW.FECHACARGO;
		FECHAVEN$:=:NEW.FECHAVEN;
		FECHAPAGO$:=:NEW.FECHAPAGO;
		IMPORTE$:=:NEW.IMPORTE;
		NUMERO_PAGOS$:=:NEW.NUMERO_PAGOS;
		PAGO$:=:NEW.PAGO;
		ABONO$:=:NEW.ABONO;
		CVS$:=:NEW.CVS;
		CARGO$:=:NEW.CARGO;
		IDINSCRIPCION$:=:NEW.IDINSCRIPCION;
		IDSERVICIO$:=:NEW.IDSERVICIO;

		PROC_TRIGGER(IDCARGO$,FECHACARGO$,FECHAVEN$,FECHAPAGO$,IMPORTE$,NUMERO_PAGOS$,PAGO$,ABONO$,CVS$,CARGO$,IDINSCRIPCION$,IDSERVICIO$);

END GENERA_DESCUENTO;
/



--CREATE OR REPLACE PROCEDURE PROC_TRIGGER(IDCARGO$ IN NUMBER,FECHACARGO$ IN DATE,FECHAVEN$ IN DATE,FECHAPAGO$ IN DATE,IMPORTE$ IN NUMBER,NUMERO_PAGOS$ IN NUMBER,PAGO$ IN NUMBER,ABONO$ IN NUMBER,CVS$ IN CHAR,CARGO$ IN NUMBER,IDINSCRIPCION$ IN NUMBER,IDSERVICIO$ IN NUMBER)
CREATE OR REPLACE PROCEDURE PROC_AFTER_GENERA_DESCUENTO(IDCARGO$ IN NUMBER)
AS
	FECHACARGO$ 	DATE;
	FECHAVEN$ 	DATE;
	FECHAPAGO$ 	DATE;
	IMPORTE$ 	NUMBER(12,2);
	NUMERO_PAGOS$ NUMBER(2);
	PAGO$ 		 NUMBER(3);
	ABONO$ 		NUMBER(12,2);
	CVS$ 		CHAR(2);
	CARGO$ 		NUMBER(8);
	IDINSCRIPCION$ NUMBER(8);
	IDSERVICIO$    NUMBER(8);

	ABONADO$ NUMBER(11,2);

	TOTAL$	NUMBER(12,2);
	IDDESCUENTO_AUTO$ NUMBER(8);
	IDCARGO_AUTO$ NUMBER(8);
	MONTODESCUENTO$ NUMBER(12,2);
	NUEVO_IMPORTE$ NUMBER(12,2);
	
BEGIN

	SELECT 	FECHACARGO,FECHAVEN,FECHAPAGO,IMPORTE,NUMERO_PAGOS,PAGO,ABONO,CVS,CARGO,IDINSCRIPCION,IDSERVICIO
	 INTO FECHACARGO$,FECHAVEN$,FECHAPAGO$,IMPORTE$,NUMERO_PAGOS$,PAGO$,ABONO$,CVS$,CARGO$,IDINSCRIPCION$,IDSERVICIO$
	 FROM CARGO WHERE IDCARGO=IDCARGO$;

	TOTAL$:= IMPORTE$ - ABONO$;
	--IDDESCUENTO$:=AUTO_IDDESCUENTO.NEXTVAL;
	MONTODESCUENTO$:=ABONO$ * 0.05;
	NUEVO_IMPORTE$:=IMPORTE$-ABONO$;

	IF TOTAL$ <= 0 THEN--SI SE SALDÒ TODO EL IMPORTE DEL CARGO
		DBMS_OUTPUT.PUT_LINE('PAGÒ POR COMPLETO');

		IF SYSDATE <= FECHACARGO$ THEN --SI SE PAGA CON TIEMPO ANTICIPADO
			IF CVS$='SI' THEN --SI SE TRATA DE UN CARGO POR SERVICIO VENCIDO NO PUEDE HABER DESCUENTO
				DBMS_OUTPUT.PUT_LINE('NO SE GENERÒ DESCUENTO');
			ELSE --SI NO  ES UN CARGO POR SERVICIO VENCIDO SÌ HAY DESCUENTO
				IDDESCUENTO_AUTO$:=AUTO_IDDESCUENTO.NEXTVAL;
				INSERT INTO DESCUENTO(IDDESCUENTO,IDCARGO,FECHADESC,IMPORTE,APLICADO,CARGOAPLICADO,REMUNERADO)
				VALUES(IDDESCUENTO_AUTO$,IDCARGO$,SYSDATE,MONTODESCUENTO$,'NO',NULL,NULL);
				DBMS_OUTPUT.PUT_LINE('SE SALDÒ COMPLETAMENTE EL CARGO: '||IDCARGO$||' Y SE GENERÒ EL DESCUENTO: '||IDDESCUENTO_AUTO$||' POR UN MONTO DE: '||MONTODESCUENTO$);
			END IF;
		ELSE --SI NO SE PAGA CON TIEMPO ANTICIPADO
			DBMS_OUTPUT.PUT_LINE('PAGÒ DESPÙES DE FECHACARGO');
		END IF;

	ELSE --SI SE PAGA PARCIALMENTE

		IF SYSDATE <= FECHACARGO$ THEN --SI SE PAGA CON TIEMPO ANTICIPADO
			IF CVS$='SI' THEN --SI SE TRATA DE UN CARGO POR SERVICIO VENCIDO NO PUEDE HABER DESCUENTO
				DBMS_OUTPUT.PUT_LINE('NO SE GENERÒ DESCUENTO');
				DBMS_OUTPUT.PUT_LINE('SE SALDÒ PARCIALMENTE EL CARGO POR VENCIMIENTO: '||IDCARGO$);

				IDCARGO_AUTO$:=AUTO_IDCARGO.NEXTVAL;
				INSERT INTO CARGO(IDCARGO,FECHACARGO,FECHAVEN,FECHAPAGO,IMPORTE,NUMERO_PAGOS,PAGO,ABONO,CVS,CARGO,IDINSCRIPCION,IDSERVICIO)
				VALUES(IDCARGO_AUTO$,SYSDATE,FECHAVEN$,NULL,NUEVO_IMPORTE$,0,0,0,'SI',IDCARGO$,IDINSCRIPCION$,IDSERVICIO$);						

				DBMS_OUTPUT.PUT_LINE('SE GENERÒ EL SUBCARGO: '||IDCARGO_AUTO$);				
			ELSE --SI NO  ES UN CARGO POR SERVICIO VENCIDO SÌ HAY DESCUENTO
				IDDESCUENTO_AUTO$:=AUTO_IDDESCUENTO.NEXTVAL;
				INSERT INTO DESCUENTO(IDDESCUENTO,IDCARGO,FECHADESC,IMPORTE,APLICADO,CARGOAPLICADO,REMUNERADO)
				VALUES(IDDESCUENTO_AUTO$,IDCARGO$,SYSDATE,MONTODESCUENTO$,'NO',NULL,NULL);
				DBMS_OUTPUT.PUT_LINE('SE SALDÒ PARCIALMENTE EL CARGO: '||IDCARGO$||' Y SE GENERÒ EL DESCUENTO: '||IDDESCUENTO_AUTO$||' POR UN MONTO DE: '||MONTODESCUENTO$);

				IDCARGO_AUTO$:=AUTO_IDCARGO.NEXTVAL;
				INSERT INTO CARGO(IDCARGO,FECHACARGO,FECHAVEN,FECHAPAGO,IMPORTE,NUMERO_PAGOS,PAGO,ABONO,CVS,CARGO,IDINSCRIPCION,IDSERVICIO)
				VALUES(IDCARGO_AUTO$,SYSDATE,FECHAVEN$,NULL,NUEVO_IMPORTE$,0,0,0,NULL,IDCARGO$,IDINSCRIPCION$,IDSERVICIO$);						

				DBMS_OUTPUT.PUT_LINE('SE GENERÒ EL SUBCARGO: '||IDCARGO_AUTO$);
			END IF;
		ELSE --SI NO SE PAGA CON TIEMPO ANTICIPADO
--MODIFICANDO

			IF CVS$='SI' THEN --SI SE TRATA DE UN CARGO POR SERVICIO VENCIDO NO PUEDE HABER DESCUENTO
				DBMS_OUTPUT.PUT_LINE('NO SE GENERÒ DESCUENTO');
				DBMS_OUTPUT.PUT_LINE('SE SALDÒ PARCIALMENTE EL CARGO POR VENCIMIENTO: '||IDCARGO$);

				IDCARGO_AUTO$:=AUTO_IDCARGO.NEXTVAL;
				INSERT INTO CARGO(IDCARGO,FECHACARGO,FECHAVEN,FECHAPAGO,IMPORTE,NUMERO_PAGOS,PAGO,ABONO,CVS,CARGO,IDINSCRIPCION,IDSERVICIO)
				VALUES(IDCARGO_AUTO$,SYSDATE,FECHAVEN$,NULL,NUEVO_IMPORTE$,0,0,0,'SI',IDCARGO$,IDINSCRIPCION$,IDSERVICIO$);						

				DBMS_OUTPUT.PUT_LINE('SE GENERÒ EL SUBCARGO: '||IDCARGO_AUTO$);				
			ELSE --SI NO  ES UN CARGO POR SERVICIO VENCIDO
				DBMS_OUTPUT.PUT_LINE('NO SE GENERÒ DESCUENTO');
				DBMS_OUTPUT.PUT_LINE('SE SALDÒ PARCIALMENTE EL CARGO: '||IDCARGO$);

				IDCARGO_AUTO$:=AUTO_IDCARGO.NEXTVAL;
				INSERT INTO CARGO(IDCARGO,FECHACARGO,FECHAVEN,FECHAPAGO,IMPORTE,NUMERO_PAGOS,PAGO,ABONO,CVS,CARGO,IDINSCRIPCION,IDSERVICIO)
				VALUES(IDCARGO_AUTO$,SYSDATE,FECHAVEN$,NULL,NUEVO_IMPORTE$,0,0,0,NULL,IDCARGO$,IDINSCRIPCION$,IDSERVICIO$);						

				DBMS_OUTPUT.PUT_LINE('SE GENERÒ EL SUBCARGO: '||IDCARGO_AUTO$);
			END IF;

		END IF;

	END IF;


END PROC_AFTER_GENERA_DESCUENTO;
/

--·#####################################

CREATE OR REPLACE PROCEDURE GENERAR_CVS
AS
	CURSOR CURSOR_TABLA_CARGO$ IS
	SELECT * FROM CARGO ORDER BY IDCARGO;

	CARGO_ACTUAL$ NUMBER(8);
	SUBCARGO$ NUMBER(8);
	FECHACARGO$ DATE;
	IMPORTE$ NUMBER(12,2);
	IDCARGO_AUTO$ NUMBER(8);

BEGIN
	
	FOR C_CARGO$ IN CURSOR_TABLA_CARGO$ LOOP
		IF (SYSDATE >= C_CARGO$.FECHAVEN) AND (C_CARGO$.ABONO = 0) THEN

			IF (C_CARGO$.CVS = 'SI') THEN
				DBMS_OUTPUT.PUT_LINE('');
			ELSE

				CARGO_ACTUAL$:=C_CARGO$.IDCARGO;
				SELECT COUNT(*) INTO SUBCARGO$ FROM CARGO WHERE CARGO=CARGO_ACTUAL$;

				IF SUBCARGO$=0 THEN
					
					IDCARGO_AUTO$:=AUTO_IDCARGO.NEXTVAL;
					FECHACARGO$:=C_CARGO$.FECHAVEN+10;
					IMPORTE$:=C_CARGO$.IMPORTE*0.05;
					INSERT INTO CARGO(IDCARGO,FECHACARGO,FECHAVEN,FECHAPAGO,IMPORTE,NUMERO_PAGOS,PAGO,ABONO,CVS,CARGO,IDINSCRIPCION,IDSERVICIO)
					VALUES(IDCARGO_AUTO$,FECHACARGO$,C_CARGO$.FECHAVEN,NULL,IMPORTE$,0,0,0,'SI',CARGO_ACTUAL$,C_CARGO$.IDINSCRIPCION,C_CARGO$.IDSERVICIO);

					--DBMS_OUTPUT.PUT_LINE('FECHACARGO= '||FECHACARGO$);
					--DBMS_OUTPUT.PUT_LINE('CARGO DEL= '||IMPORTE$);

				END IF;

			END IF;

		END IF;

	END LOOP;

END GENERAR_CVS;
/

EXEC GENERAR_CVS;

